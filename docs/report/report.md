# Отчёт о выполнении задачи "Drone"

- [Отчёт о выполнении задачи "Drone"](#отчёт-о-выполнении-задачи-drone)
  - [Постановка задачи](#постановка-задачи)
  - [Известные ограничения и вводные](#известные-ограничения-и-вводные)
    - [Цели и Предположения Безопасности (ЦПБ)](#цели-и-предположения-безопасности-цпб)
      - [Цели](#цели)
      - [Предположения](#предположения)
  - [Архитектура решения](#архитектура-решения)
    - [Компоненты](#компоненты)
    - [Алгоритм работы решения](#алгоритм-работы-решения)
      - [Монитор безопасности (security monitor)](#монитор-безопасности-security-monitor)
      - [Дрон](#дрон)
      - [Мобильное приложение](#мобильное-приложение)
      - [Управляющий центр](#управляющий-центр)
  - [Безопасность](#безопасность)
    - [Выполнение целей безопасности](#выполнение-целей-безопасности)
      - [1. обеспечение безопасности дрона от перехвата управления](#1-обеспечение-безопасности-дрона-от-перехвата-управления)
      - [2. получение задания только от корпоративного сервера](#2-получение-задания-только-от-корпоративного-сервера)
      - [3. противодействие Dos-атакам](#3-противодействие-Dos-атакам)
      - [4. (дополнительно) противодействие от взлома мобильного приложения с условием физического доступа](#4-дополнительно-противодействие-от-взлома-мобильного-приложения-с-условием-физического-доступа)
      - [(без номера). противодействие от взлома дрона с условием физического доступа](#без-номера-противодействие-от-взлома-дрона-с-условием-физического-доступа)
    - [Компрометация сервисов](#компрометация-сервисов)
      - [Компрометация дрона](#компрометация-дрона)
      - [Компрометация мобильного приложения](#компрометация-мобильного-приложения)
      - [Компрометация управляющего центра](#компрометация-управляющего-центра)
    - [Рассмотрение других негативных сценариев (из задания) ](#рассмотрение-других-негативных-сценариев-из-задания)
      - [Физический доступ к смартфону с мобильным приложением](#физический-доступ-к-смартфону-с-мобильным-приложением)
      - [Подключение к недоверенному роутеру. Атака через каналы связи](#подключение-к-недоверенному-роутеру-атака-через-каналы-связи)
      - [Недостаточная защита от подбора учетных данных](#недостаточная-защита-от-подбора-учетных-данных)
      - [Глушение канала передачи информации мобильное приложение <--> дрон](#глушение-канала-передачи-информации-мобильное-приложение----дрон)
      - [Перехват команды/полетного задания и внедрение в него недостоверной информации](#перехват-командыполетного-задания-и-внедрение-в-него-недостоверной-информации)
      - [DDoS-атака на управляющий центр](#ddos-атака-на-управляющий-центр)
    - [Итоговые изменения в архитектуре](#итоговые-изменения-в-архитектуре)
    


## Постановка задачи

Задача заключается в реализации ПО дрона, мобильного приложения и управляющего центра таким образом, чтобы управление летательным аппаратом можно было считать безопасным.

## Известные ограничения и вводные

По условиям организаторов должна использоваться микросервисная архитектура и шина обмена сообщениями для реализации асинхронной работы сервисов.

### Цели и Предположения Безопасности (ЦПБ)

#### Цели 

1. обеспечение безопасности дрона от перехвата управления
2. получение задания только от корпоративного сервера
3. противодействие Dos-атакам
4. (дополнительно) противодействие от взлома мобильного приложения с условием физического доступа

Стоит сразу отметить, что первая цель безопасности не нарушается, если злоумышленник получил информацию о полете. В некоторых негативных сценариях (например, при взломе PIN-кода мобильного приложения) может быть допущено такое раскрытие информации, однако оно не считается критичным, т.к. перехвата управления не произошло.

#### Предположения

1. защита от намеренного искажения GPS-координат
2. сервис "Монитор безопасности" (SM) является полностью доверенным (см.ниже)
3. обмен сообщениями через сервис "Шина обмена сообщениями" (Message Bus) надежно защищен от любого взлома
4. управляющий центр вместе с оператором находят в физически защищенном месте (специализированная комната/серверная)

## Архитектура решения

### Компоненты

| Название | Назначение | 
|----|----|
|*Drone* | реализация ПО летательного аппарата | 
|*Mobile* | реализация мобильного приложения для управления дроном|
|*Control_center* | управляющий центр, который распределяет и выдает задания, а также регистрирует информацию об инцидентах | 
|*Security monitor*<br>(монитор безопасности) | авторизует операцию, если она удовлетворяет заданным правилам или блокирует её в противном случае| |
|*Message bus* | шина сообщений и брокер - сервис передачи сообщений от источника получателям | kafka+zookeeper |

Более подробное описание о функциях компонентов, логике их работы и методах взаимодействия см. ниже

![HLA](./diagrams/docs/report/all_arch/all_arch.png?raw=true "Архитектура общая")

### Алгоритм работы решения

![ARCH](./diagrams/docs/report/arch/arch.png?raw=true "Архитектура")

#### Монитор безопасности (security monitor)

Для монитора безопасности была использована реализация из проекта secure_update. В оригинальном проекте важную роль играет последовательность действий, в то время как в данном - это не так важно (последовательность важна только в логике работы дрона, а не передачи сообщения; например, дрон не отправится на задание до запуска мобильным приложением). Поэтому в этом проекте SM выступает исключительно как средство фильтрации, позволяя реализовать доставку сообщений от авторизованных сторон. Таким образом, решается вторая цель безопасности, которая гласит, что задания могут быть получены только от управляющего центра.

#### Дрон

ПО дрона является ключевым в данном проекте. На него возложена большая часть функциональной безопасности (safety). У дрона можно включить и отключить питание через REST запрос (на данном этапе выключенное питание дрона влияет только на то, что вы не сможете получить информацию о состоянии; это было сделано для простоты тестирования). Также этот запрос может не только включить дрон, но и установить его параметры, такие как заряд батареи, уровень смеси и т.д. Это было реализовано для тестирования. Также с помощью REST запроса можно получить информацию о текущем состоянии дрона, т.е. уровень батареи, количество смеси, текущие координаты, состояние устройств. Считается, что такой запрос - это индикация состояния на табло дрона. Также состояние отображает причины ошибки последнего полета, если имеются.
Дрон отправляется на задание только по команде с мобильного приложения. Мобильное приложение также может получать информацию о состоянии дрона, в том числе во время полета. Чтобы получить доступ к дрону с мобильного приложения, необходимо знать пароль от дрона. Это позволяет защититься от атак с других мобильных приложений. Пароль на дроне хранится не в открытом виде, а в виде хэш-значения, что позволяет защитить пароль в случае физического вскрытия дрона (такие атаки уместны для небольших устройств с недостаточной физической защитой, таких как дроны, датчики).
После запуска с мобильного приложения, дрон отправляет запрос управляющему центру, чтобы получить задание. Задание может быть некорректное. В таком случае дрон остается на месте, оповещает пользователя об ошибке (индикатор на табло), а также отправляет сообщение мобильному приложению. На данный момент корректность проверяется достаточно просто: если есть возможность интерпритировать данные полета как числовые значения, значит задание корректно. Перед отправкой безопасность задания проверяется управляющим центром (дрон этого сделать не может).
Работа дрона реализована как отдельный процесс. С точки зрения логики работа реализована так: дрон двигается до стартовой точки, отправляет сообщение мобильному приложению о начале распрыскивания, обрабатывает территорию (двигаясь змейкой), отправлят сообщение мобильному приложению о завершении работы и отправляется домой. 
![ALG_D](./diagrams/docs/report/alg_drone/alg_drone.png?raw=true "Алгоритм работы дрона")
Если мобильное приложение запросит информацию о состоянии во время полета, то дрон помимо основной информации, вернет также статус и процент выполненной работы. Так как выполняемая работы и ответ на запрос - это два разных процесса, обмен рабочей информацией происходит через файл, как альтернатива межпроцессорному взаимодействию (такое решение было выбрано в связи с отсутствием времени).
Ориентирование и движение дрона реализовано с помощью функции GPS. Это прототип реальной системы навигации: реализованная функция лишь берет текущие координаты и увеличивает на один в зависимости от заданного направления. Также существует cheat-запрос, который заставляет функцию GPS вернуть ошибку, что дает возможность протестировать нештатную ситуацию.
Во время работы каждый раз при смещении на новую позицию дрон выполняет ряд проверок безопасности:
1. нет ли ошибки навигации
2. какое расстояние до земли (если расстояние меньше заданного порога, то под дроном человек, животное или здание; данная проверка проводится только во время распрыскивания)
3. нормальное ли состояние дрона (на данный момент это включает в себя только проверку на то, что дрону хватает заряда батареи на возвращение до базы)
4. не происходит ли анамальное количество неавторизованных запросов
5. не было ли запроса от мобильного приложения на принудительную остановку работы

Если хоть одна из проверок сигнализирует о проблемах безопасности, то дрон сохраняет код ошибки, отправляет сообщение мобильному приложению и возвращается на базу. Возвращение на базу - процедура, которая должна быть выполнена на аппаратном уровне дрона без использования функции навигации и других, поэтому в проекте она реализована примитивно.
Как уже было сказано, работа дрона может быть принудительно остановлена с помощью мобильного приложения (для этой операции также требуется пароль).
По окончанию работы (в случае успеха) дрон отправляет сообщение не только мобильному приложению, но и управляющему центру.

#### Мобильное приложение

Доступ к мобильному приложению осуществляется только по PIN-коду. Таким образом, происходит противодействие атакам с физическим доступом. Мобильное приложение может запрашивать состояние дрона (и "выводить его на экран"), запускать дрон для работы (включение питания - не то же самое, что и запуск для работы), принудительно возвращать дрон на базу. Также мобильное приложение получает различную информацию от дрона, в том числе и информацию об инцидентах. В данном проекте считается, что любая ошибка во время задания - это инцидент. Информацию об инцидентах отправляется с мобильного приложения в управляющий центр для фиксации в журнал. 

#### Управляющий центр

Обычно управляющий центр находится в специализированном помещении/серверной, поэтому доступ по паролю не был реализован. Управляющий центр с помощью REST запросов получает пул заданий, который в последствии выдается дронам. Управляющий центр выполняет проверку задания на безопасность, т.е. проверяется, не столкнутся ли дроны во время полета, не обработают ли дважды одну и ту же территорию и т.д. Однако на данный момент в проекте проверка безопасности реализована примитивно. 
По запросу от дрона управляющий центр выдает задание. 
Управляющий центр также получает информацию обо всех инцидентах, а также ведет их журнал, который можно просмотреть по REST запросу. Журнал не обнуляется с оканчанием полета. 


## Безопасность
### Выполнение целей безопасности
Рассмотрим поэтапно каждую цель безопасности.

#### 1. обеспечение безопасности дрона от перехвата управления
Перехват управлением может быть по следующим векторам: 
1. взлом мобильного приложения
2. взлом управляющего центра
3. манипуляции с каналом связи между мобильным приложением и дроном
4. манипуляции с каналом связи между управляющим центром и дроном

Манипуляции с каналом связи между мобильным приложением и управляющим центром не рассматриваются, так как они исключительно информативные. Т.е. может произойти подмена информации, но на перехват управлением это не влияет.

Пункты 1 и 2 могут быть реализованы с помощью физического доступа и уязвимостей ПО. Уязвимости ПО будут рассмотрены далее. С точки зрения физического доступа, мобильное приложение защищено PIN-кодом, а доступ от него к дрону - паролем. Считается, что управляющий центр физически находится в защищенном месте.

Пункты 3 и 4 не могут быть реализованы, так как все общение между сервисами происходит через Message Bus, т.е. шину, которая по предположениям безопасности является надежной. Неавторизованный запрос всегда будет отфильтрован монитором безопасности.

#### 2. получение задания только от корпоративного сервера
Данная цель безопасности реализуется с помощью правила SM, который позволяет отправлять задания дрону только от управляющего центра.
Если управляющих центров может быть несколько, то целесообразно реализовать проверку с помощью сертификата (хотя это очень трудоемко для маломощного дрона). В данном проекте считается, что легитимный УЦ только один

#### 3. противодействие Dos-атакам
Неавторизованные запросы к дрону могут приходить:
1. с неизвестного сервиса
2. с мобильного приложения, но без верного пароля (если это чужое мобильное приложение)

В первом случае запросы не будут вообще поступать в дрон, так как будут фильтроваться монитором безопасности.
Для второго случая реализована функция на дроне, которая возвращает дрон на базу (такое решеник было установлено в задании) 

#### 4. (дополнительно) противодействие от взлома мобильного приложения с условием физического доступа

Мобильное приложение защищено PIN-кодом, а доступ к дрону - паролем. Даже в том случае, если PIN-код окажется ненадежным и будет взломан, то подбор пароля к дрону не удастся, т.к. на дроне ограничено количество неавторизованных запросов (см. пункт 3 "противодействие DoS атакам")

#### (без номера). противодействие от взлома дрона с условием физического доступа

Конечно, информационные технологии не смогут защитить дрон от вандалов или хищных птиц. Однако этому пункту хотелось уделить внимание, так как реализованы некоторые функции безопасности, противодействующие физическому снятию информации с носителей. Такие атаки актуальны для устройств в открытом пространстве. При реализации защиты также важно сохранять баланс между требованиями этих реализаций и возможностями самого устройства, т.к. часто дроны являются маломощным.
В данном проекте была реализована одна функция защиты - отсутствие хранения пароля в откртом виде (хорошо было бы добавить "соль", но времени очень не хватало).

### Компрометация сервисов

#### компрометация дрона
Здесь мы не будем рассматривать компрометацию самого дрона, потому что эксплуатация уязвимости дрона может привести к тому, что дрон выполнит неверные команды без какого-либо управления извне. Это необходимо учитывать и, наверное, относить ПО дрона к предположительно доверенным. Или хотя бы его часть, которая выполняет функции безопасности полета.

#### компрометация мобильного приложения
Если проэксплуатировать некую уязвимость в мобильном приложении, то может наступить одно из следующих событий:
1. мобильное приложение не отправило информацию об ошибках в управляющий центр
![B_M1](./diagrams/docs/report/bad_mobile1/bad_mobile1.png?raw=true "Компрометация МП1")
2. мобильное приложение отправляет дрон домой до выполнения задания
![B_M2](./diagrams/docs/report/bad_mobile2/bad_mobile2.png?raw=true "Компрометация МП2")
3. мобильное приложение отправляет управляющему центру информацию об инциденте, которого не было
![B_M3](./diagrams/docs/report/bad_mobile3/bad_mobile3.png?raw=true "Компрометация МП3")
4. мобильное приложение запускает дрон для работы даже в случае ошибок дрона
![B_M4](./diagrams/docs/report/bad_mobile4/bad_mobile4.png?raw=true "Компрометация МП4")

Пункты 1 и 3 имеют место быть. К сожалению, пункт 1 никак нельзя предотвратить. Есть два решения: 
1) Постоянный опрос мобильного приложения (на случай, если информацию просто забыли отправить) и/или самого дрона (на случай, если мобильное приложение умышленно скрывает информацию). С практической точки зрения такое решение не кажется оправданным, т.к. влечет большую нагрузку на все сервисы.
2) Отслеживание завершения заданий со стороны управляющего центра. Т.е. через заданное большое количество времени после выдачи задания и не получения информации о завершении, управляющий центр может "догадаться", что что-то пошло не так. Однако истинную причину ошибки и объем выполненного задания УЦ так и не узнает.
Пункт 3 может быть проверен в мониторе безопасноти: если сообщение об ошибке было отправлено от дрона мобильному приложению, то лишь тогда мобильное приложение может отправлять сообщение об ошибке управляющему центру

Пункт 2 не может быть полностью запрещен, т.к. это разрешенная для мобильного приложения функция. Однако управляющий центр должен получить информацию о том, что задание не было выполнено до конца. Так как мобильное приложение было взломано, то гарантировать это нельзя (см. пункт 1).

Размышления о безопасности пунктов 1-3 наводят на мысль о том, что необходимо изменить последовательность действий в архитектуре. Необходимо отправлять информацию о завершении полета (в том числе об аварийном завершении) управляющему центру не от мобильного приложения, а от самого дрона. Если дрон "не захочет" отправлять информацию о своей работе, то он не отправить ее никому (что снова говорит о том, что ПО дрона не должно содержать закладок и эксплутируемых уязвимостей).
Тогда измененная архитектура будет выглядеть так:
![ARC_CH1](./diagrams/docs/report/arch_ch1/arch_ch1.png?raw=true "Изменения в архитектуре 1")

Тут же возникает вопрос: какие будут последствия, если дрон отправит разные информационные сообщения мобильному приложению и управляющему центру? Информация, полученная мобильным приложением, никак не влияет на дальнейшую логику работы. Поэтому такая ситуация равносильна отправке неверных данных от дрона обоим сторонам. Об этом говорили выше в "компрометации дрона".

Пункту 4 противодействуют реализованные функции безопасности в работе дрона.

#### компрометация управляющего центра
Если проексплуатировать некую уязвимость в управляющем центре, то может наступить одно из следующих событий:
1. управляющий центр выдает неверное/небезопасное задание
![B_CC1](./diagrams/docs/report/bad_cc1/bad_cc1.png?raw=true "Компрометация УЦ1")
2. управляющий центр не регистрирует выполненное задание и/или аварию
3. управляющий центр отправил задание дрону, но не отправил мобильному приложению
![B_CC3](./diagrams/docs/report/bad_cc3/bad_cc3.png?raw=true "Компрометация УЦ3")
4. управляющий центр отправил задание мобильному приложению, но не отправил дрону
![B_CC4](./diagrams/docs/report/bad_cc4/bad_cc4.png?raw=true "Компрометация УЦ4")

Пункт 1 частично покрывается работой дрона, который выполняет проврки функциональоой безопасности. То есть, если было выдано задание распылить химикаты над людьми или над городом, то такое задание не будет выполнено самим дроном. Однако УЦ может выдать задание, которое для дрона будет выглядеть безопасным, хотя это не так. Например, УЦ может несколько раз выдать задание на обработку одного и того же участка. Причем дубликаты заданий могут быть отправлены разным дронам. 
В таком случае можно рассмотреть следующее решение - каждое отправляемое задание при добавлении в пул заданий должно быть подтверждено оператором и заверено цифровой подписью (образованной от секретного ключа оператора и самого задания). Таким образом, злоумышленники не смогут подделывать новые задания без знания секретного ключа оператора. В свою очередь SM должен проверять id заданий, чтобы избежать атаки репликации.
![ARC_CH2](./diagrams/docs/report/arch_ch2/arch_ch2.png?raw=true "Изменения в архитектуре 2")
Пункт 2 не влияет на управление, но может повлиять на восприятие оператором, который будет считать, что задание выполнено, когда оно было выполнено не до конца. Такое поведение нельзя предотвратить, потому что оператор управляющего центра не может взаимодействовать с другими участниками сети.
Для противодействия пункту 3 дрон до начала задания отправляет информационное сообщение мобильному приложению.
Для противодействия пункту 4 мобильное приложение может запросить состояние дрона, чтобы понять, что дрон не работает.

### Рассмотрение других негативных сценариев (из задания) 

#### Физический доступ к смартфону с мобильным приложением

При получении физического доступа к мобильному приложению злоумышленнику необходимо ввести PIN-код, чтобы отправлять команды или получать какие-либо данные

#### Подключение к недоверенному роутеру. Атака через каналы связи

Для противодействия атакам через каналы связи могут быть использованы такие средства защиты как VPN, в том числе шифрование и проверка целостности данных.
В данном проекте вся передача реализуется через Message Bus, которая считается надежной и защищенной

#### Недостаточная защита от подбора учетных данных

Если PIN-код от мобильного приложения был получен путем перебора, то злоумышленник может получить данные о полете, но не сможет управлять дроном, т.к. для этого необходим пароль от дрона.
Пароль от дрона не может быть взломан путем перебора, т.к. в дроне стоит ограничение неавторизованных запросов.
Физический доступ к управляющему центру не рассматривается.

####  Глушение канала передачи информации мобильное приложение <--> дрон

Во время выполнения задания дрон самостоятельно проверяет безопасность полета и в аварийном случае возвращается на базу.

#### Перехват команды/полетного задания и внедрение в него недостоверной информации

Для противодействия атакам через каналы связи могут быть использованы такие средства защиты как VPN, в том числе шифрование и проверка целостности данных.
В данном проекте вся передача реализуется через Message Bus, которая считается надежной и защищенной

#### DDoS-атака на управляющий центр
Неавторизованные запросы будут фильтроваться на уровне монитора безопасности.
Если посылать большое количество информационных сообщений со взломанного дрона/мобильного приложения, то злоумышленнику также необходимо подобрать верный id. Получить id через компрометацию канала связи нельзя, т.к. Message Bus является защищенной.
Количество выданных заданий (т.е. количество id) ограничено, таким образом, можно говорить только о DoS атаке (атака не является распределенной). Управляющий центр должен иметь достаточно ресурсов, чтобы обрабатывать большое количество информации от ограниченного количества участников.

### Итоговые изменения в архитектуре

Рассмотрев множество аспектов безопасности, в архитектуру и логику решения были внесены следующие изменения:
1. Дрон отправляет сообщение о завершении работы не только мобильному приложению, но и управляющему центру. 
2. Задания, поступающие на вход управляющего центра должны быть подписаны оператором
3. Задания должны отслеживаться управляющим центром
4. ПО дрона или хотя бы его часть, отвечающая за функциональную безопасность и аварийное возвращение должна быть свободна от закладок и уязвимостей.
Все изменения были внесены в реализацию проекта. Изменение под пунктом 2 было реализовано примитивным способом.
![ARC_CH_ALL](./diagrams/docs/report/arch_ch_all/arch_ch_all.png?raw=true "Изменения в архитектуре")